name: Deploy FastAPI to EC2

on:
  push:
    branches:
      - master

env:
  REMOTE_PROJECT_DIR: ${{ secrets.CANAGENT_REMOTE_PATH }}
  STACK_NAME: stack-fastapi
  COMPOSE_FILE: docker-compose.prod.yaml

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect build-impacting changes
        id: detect_changes
        run: |
          set -euo pipefail
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            CHANGED_FILES=$(git ls-tree -r --name-only HEAD)
          fi
          echo "Changed files:"
          echo "$CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -Eq '^(Dockerfile|requirements\.txt|docker-compose\.prod\.yaml)$'; then
            echo "rebuild=true" >> "$GITHUB_OUTPUT"
          else
            echo "rebuild=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy stack-fastapi
        env:
          EC2_HOST: ${{ secrets.EC2_IP_ADDRESS }}
          REBUILD_FLAG: ${{ steps.detect_changes.outputs.rebuild }}
        run: |
          set -euo pipefail
          if [ -z "${EC2_HOST:-}" ]; then
            echo "Missing EC2_IP_ADDRESS secret"
            exit 1
          fi

          REMOTE_PATH_VALUE="${REMOTE_PROJECT_DIR:-/home/ubuntu/cannagent}"
          STACK_VALUE="${STACK_NAME:-stack-fastapi}"
          COMPOSE_FILE_VALUE="${COMPOSE_FILE:-docker-compose.prod.yaml}"
          REBUILD_VALUE="${REBUILD_FLAG:-false}"

          ssh -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=60 \
            "ubuntu@${EC2_HOST}" \
            "REMOTE_PROJECT_DIR='${REMOTE_PATH_VALUE}' STACK_NAME='${STACK_VALUE}' COMPOSE_FILE='${COMPOSE_FILE_VALUE}' REBUILD_IMAGES='${REBUILD_VALUE}' bash -s" <<'EOF'
              set -euo pipefail
              REMOTE_PATH="${REMOTE_PROJECT_DIR:-/home/ubuntu/cannagent}"
              STACK="${STACK_NAME:-stack-fastapi}"
              COMPOSE_FILE_PATH="${COMPOSE_FILE:-docker-compose.prod.yaml}"

              echo "Using remote path: $REMOTE_PATH"
              cd "$REMOTE_PATH"

              echo "Ensuring git state is clean..."
              git fetch origin master
              git reset --hard origin/master

              echo "Loading environment variables..."
              set -a
              if [ -f .env ]; then
                source .env
              fi
              set +a

              echo "Verifying cancon_canna-network exists (should be created by canna project)..."
              if ! docker network inspect cancon_canna-network >/dev/null 2>&1; then
                echo "ERROR: Network cancon_canna-network does not exist. Deploy canna project first."
                exit 1
              fi

              export COMPOSE_PROJECT_NAME="$STACK"

              echo "Stopping existing stack..."
              docker-compose -f "$COMPOSE_FILE_PATH" down
              echo "Ensuring old containers are removed (in case of naming conflicts)..."
              docker rm -f canagent-api canagent-redis >/dev/null 2>&1 || true

              echo "Ensuring pgvector extension is installed..."
              if docker ps --format '{{.Names}}' | grep -q '^canna-postgres$'; then
                docker cp scripts/init_pgvector.sql canna-postgres:/tmp/init_pgvector.sql
                PGPASSWORD="${POSTGRES_PASSWORD:-}" docker exec -e PGPASSWORD canna-postgres \
                  psql -U "${POSTGRES_USER:-postgres}" -d "${POSTGRES_DB:-postgres}" -f /tmp/init_pgvector.sql || \
                  echo "WARNING: pgvector initialization failed; ensure extension is installed in DB image"
              else
                echo "WARNING: canna-postgres container not found; skipped pgvector initialization."
              fi

              if [ "${REBUILD_IMAGES}" = "true" ]; then
                echo "Docker config or dependencies changed, rebuilding..."
                docker-compose -f "$COMPOSE_FILE_PATH" build --no-cache
              else
                echo "No Docker config or dependency changes detected; skipping rebuild."
              fi

              echo "Starting updated stack..."
              docker-compose -f "$COMPOSE_FILE_PATH" up -d

              echo "Current container status:"
              docker-compose -f "$COMPOSE_FILE_PATH" ps
          EOF
